name: Flask Deploy to VPS

on:
  workflow_call:
    inputs:
      app_name:
        description: "アプリ名（PM2名 & /var/www/ディレクトリ名）"
        required: true
        type: string
      port:
        description: "ヘルスチェック用ポート"
        required: true
        type: number
      health_check_path:
        description: "ヘルスチェックのパス"
        required: false
        type: string
        default: "/"
      python_version:
        description: "Pythonバージョン"
        required: false
        type: string
        default: "3.11"
      env_setup_script:
        description: "VPS上の.envセットアップスクリプト"
        required: false
        type: string
        default: ""
      db_path:
        description: "DBファイルの相対パス（空ならDBバックアップスキップ）"
        required: false
        type: string
        default: ""
    secrets:
      VPS_HOST:
        required: true
      VPS_USER:
        required: true
      VPS_SSH_KEY:
        required: true
      VPS_PORT:
        required: true

jobs:
  # ステップ1: GitHub Actions上でテスト（VPSに触らずに検証）
  build-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: python -m pytest -v
        env:
          FLASK_ENV: testing

  # ステップ2: テスト成功後にVPSへデプロイ
  deploy:
    runs-on: ubuntu-latest
    needs: build-check
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 10m
          script: |
            set -e
            APP_NAME="${{ inputs.app_name }}"
            APP_DIR="/var/www/$APP_NAME"
            PORT="${{ inputs.port }}"
            HEALTH_PATH="${{ inputs.health_check_path }}"
            DB_PATH="${{ inputs.db_path }}"

            cd "$APP_DIR"

            echo "=== デプロイ開始: $APP_NAME ==="

            # --- .env セットアップ ---
            ENV_SETUP_SCRIPT=$(cat << 'ENVSETUP'
            ${{ inputs.env_setup_script }}
            ENVSETUP
            )
            if [ -n "$ENV_SETUP_SCRIPT" ]; then
              echo ">>> .env セットアップ実行中..."
              eval "$ENV_SETUP_SCRIPT"
              echo ">>> .env キー一覧:"
              grep -E "^[A-Z_]+=" "$APP_DIR/.env" | sed 's/=.*/=***/' || true
            fi

            # --- バックアップ作成 ---
            echo ">>> バックアップ中..."
            BACKUP_DIR="$APP_DIR/.deploy-backup"
            rm -rf "$BACKUP_DIR"
            mkdir -p "$BACKUP_DIR"

            git rev-parse HEAD > "$BACKUP_DIR/git-head.txt"
            echo ">>> バックアップ完了: $(cat $BACKUP_DIR/git-head.txt)"

            # --- DB バックアップ（デプロイ前） ---
            echo ">>> DB バックアップ中..."
            if [ -f /var/backups/sqlite/backup.sh ]; then
              /var/backups/sqlite/backup.sh deploy "$APP_NAME" || echo "警告: DB バックアップ失敗（デプロイは続行）"
            else
              echo ">>> DB バックアップスクリプト未設置（スキップ）"
            fi

            # --- ロールバック関数 ---
            rollback() {
              echo "!!! デプロイ失敗 - ロールバック開始 !!!"

              if [ -f "$BACKUP_DIR/git-head.txt" ]; then
                PREV_HEAD=$(cat "$BACKUP_DIR/git-head.txt")
                echo ">>> git checkout $PREV_HEAD..."
                git checkout "$PREV_HEAD" -- . 2>/dev/null || true
              fi

              # --- DB 復元 ---
              if [ -n "$DB_PATH" ] && ls /var/backups/sqlite/$APP_NAME/deploy/*.db 1>/dev/null 2>&1; then
                LATEST_DB_BACKUP=$(ls -t /var/backups/sqlite/$APP_NAME/deploy/*.db | head -1)
                echo ">>> DB 復元中: $LATEST_DB_BACKUP"
                pm2 stop "$APP_NAME" 2>/dev/null || true
                cp "$LATEST_DB_BACKUP" "$APP_DIR/$DB_PATH"
                echo ">>> DB 復元完了"
              fi

              echo ">>> PM2 を旧バージョンで再起動..."
              pm2 startOrRestart ecosystem.config.cjs 2>/dev/null || true
              sleep 5
              echo ">>> ロールバック完了"
              pm2 status
              exit 1
            }

            # --- コード取得 ---
            echo ">>> git pull..."
            git checkout -- . 2>/dev/null || true
            git pull origin main || rollback

            # --- Python仮想環境 ---
            echo ">>> venv セットアップ..."
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate

            # --- 依存パッケージ ---
            echo ">>> pip install..."
            pip install -r requirements.txt || rollback

            # --- データディレクトリ ---
            if [ -n "$DB_PATH" ]; then
              DB_DIR=$(dirname "$DB_PATH")
              mkdir -p "$DB_DIR"
            fi

            # --- PM2再起動 ---
            echo ">>> PM2 restart..."
            pm2 startOrRestart ecosystem.config.cjs || rollback

            # --- ヘルスチェック ---
            echo ">>> ヘルスチェック中（最大30秒）..."
            HEALTH_OK=false
            for i in $(seq 1 6); do
              sleep 5
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${PORT}${HEALTH_PATH}" 2>/dev/null || echo "000")
              echo ">>> 試行 $i/6: HTTP $HTTP_CODE"
              if [ "$HTTP_CODE" = "200" ]; then
                HEALTH_OK=true
                break
              fi
            done

            if [ "$HEALTH_OK" = false ]; then
              echo "!!! ヘルスチェック失敗（HTTP応答なし）"
              echo ">>> PM2 ログ:"
              pm2 logs "$APP_NAME" --nostream --lines 30
              rollback
            fi

            echo ">>> ヘルスチェック成功"

            # --- 完了 ---
            echo ">>> PM2 status:"
            pm2 status
            echo ">>> PM2 logs (最新10行):"
            pm2 logs "$APP_NAME" --nostream --lines 10

            echo "=== デプロイ完了（正常）: $APP_NAME ==="
